<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìƒˆ í¬ìŠ¤íŒ… - NBTI ê¸¸ë“œ</title>
  <meta name="color-scheme" content="dark light">
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="./styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script type="module" src="./js/firebase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/supabase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/firebase-data-manager.js?v=1.0.0"></script>
  <script src="./js/header-component.js?v=1.0.0"></script>
  <script src="./js/footer-component.js?v=1.0.0"></script>
  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body>
  <!-- í—¤ë”ëŠ” í—¤ë” ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <!-- <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">ìƒˆ í¬ìŠ¤íŒ…</h1> -->
    </div>
  </section>

  <div class="wrap">
    <!-- ê¶Œí•œ í™•ì¸ ì„¹ì…˜ -->
    <div id="permissionSection" class="permission-section" style="display: none;">
      <div class="permission-card">
        <h2>ğŸš« ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
        <p>ìŠ¹ì¸ëœ ì‚¬ìš©ì ë˜ëŠ” ê´€ë¦¬ìë§Œ í¬ìŠ¤íŒ…ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <a href="picture.html" class="btn btn-primary">ì‚¬ì§„ì²©ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </div>

    <!-- í¬ìŠ¤íŒ… ì‘ì„± ì„¹ì…˜ -->
    <div id="postingSection" class="posting-section">
      <div class="posting-container">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="posting-header">
          <a href="picture.html" class="back-btn">
            <i class="fa-solid fa-arrow-left"></i>
            <span>ëŒì•„ê°€ê¸°</span>
          </a>
        </div>
        
        <!-- ì œëª© -->
        <div class="posting-title">
          <h2>ìƒˆ í¬ìŠ¤íŒ… ì‘ì„±</h2>
        </div>

        <!-- í¬ìŠ¤íŒ… ì—ë””í„° -->
        <div class="posting-editor">
          <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ -->
          <div class="image-upload-section">
            <div class="upload-area" id="uploadArea">
              <div class="upload-placeholder">
                <i class="fa-solid fa-images"></i>
                <h3>ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”</h3>
                <p>ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
                <span>ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥</span>
              </div>
              <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
            </div>
            
            <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì¸ë„¤ì¼ ì„ íƒ -->
            <div class="image-preview-section" id="imagePreviewSection" style="display: none;">
              <div class="preview-header">
                <h3>ì—…ë¡œë“œëœ ì‚¬ì§„</h3>
                <p>ë©”ì¸ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©í•  ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
              </div>
              <div class="image-grid" id="imageGrid"></div>
            </div>
          </div>

          <!-- íƒœê·¸ ì…ë ¥ ì˜ì—­ -->
          <div class="tag-section">
            <div class="tag-header">
              <h3>íƒœê·¸</h3>
              <p>í¬ìŠ¤íŒ…ê³¼ ê´€ë ¨ëœ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            <div class="tag-input-container">
              <input type="text" id="tagInput" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (ì˜ˆ: #ê¸¸ë“œ #ëª¨ì„)">
              <div class="tag-list" id="tagList"></div>
            </div>
          </div>

        </div>
        
        <!-- ë°œí–‰í•˜ê¸° ë²„íŠ¼ -->
        <div class="posting-footer">
          <button type="button" class="btn btn-primary publish-btn" id="publishBtn" disabled>
            <i class="fa-solid fa-paper-plane"></i>
            ë°œí–‰í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- í¬ë¡­ ëª¨ë‹¬ -->
  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
      <div class="crop-modal-header">
        <h3>ì´ë¯¸ì§€ í¬ë¡­</h3>
        <button class="crop-modal-close" id="cropModalClose">&times;</button>
      </div>
      <div class="crop-modal-body">
        <div class="crop-container">
          <img id="cropImage" src="" alt="í¬ë¡­í•  ì´ë¯¸ì§€">
        </div>
        <div class="crop-controls">
          <button type="button" class="btn btn-secondary" id="cropCancel">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="cropConfirm">ì ìš©</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const headerComponent = new HeaderComponent();
    const permissionSection = document.getElementById('permissionSection');
    const postingSection = document.getElementById('postingSection');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const imagePreviewSection = document.getElementById('imagePreviewSection');
    const imageGrid = document.getElementById('imageGrid');
    const tagInput = document.getElementById('tagInput');
    const tagList = document.getElementById('tagList');
    const publishBtn = document.getElementById('publishBtn');
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const cropModalClose = document.getElementById('cropModalClose');
    const cropCancel = document.getElementById('cropCancel');
    const cropConfirm = document.getElementById('cropConfirm');
    
    let selectedFiles = [];
    let selectedTags = [];
    let mainThumbnailIndex = 0;
    let currentUser = null;
    let isAdmin = false;
    let isApprovedUser = false;
    let cropper = null;
    let currentCropIndex = -1;

    function convertToWebP(file, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
          reject(new Error('ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤'));
          return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          canvas.toBlob((blob) => {
            if (blob && blob.size > 0) {
              resolve(blob);
            } else {
              reject(new Error('WebP ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'));
            }
          }, 'image/webp', quality);
        };
        
        img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'));
        img.src = URL.createObjectURL(file);
      });
    }

    function handleFileSelection(files) {
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      
      if (imageFiles.length === 0) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedFiles.length + imageFiles.length > 10) {
        alert('ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      selectedFiles = [...selectedFiles, ...imageFiles];
      displayImagePreviews();
      updatePublishButton();
    }

    function displayImagePreviews() {
      imageGrid.innerHTML = '';
      
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const previewItem = document.createElement('div');
          previewItem.className = `preview-item ${index === mainThumbnailIndex ? 'main-thumbnail' : ''}`;
          previewItem.innerHTML = `
            <div class="preview-image">
              <img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°">
              ${index === mainThumbnailIndex ? '<div class="main-badge">ë©”ì¸</div>' : ''}
            </div>
            <div class="preview-actions">
              <button type="button" class="set-main-btn" data-index="${index}">
                ${index === mainThumbnailIndex ? 'ë©”ì¸ ì¸ë„¤ì¼' : 'ë©”ì¸ìœ¼ë¡œ ì„¤ì •'}
              </button>
              <button type="button" class="crop-btn" data-index="${index}">
                <i class="fa-solid fa-crop"></i> í¬ë¡­
              </button>
              <button type="button" class="remove-btn" data-index="${index}">
                <i class="fa-solid fa-times" style="color: black;"></i>
              </button>
            </div>
          `;
          
          imageGrid.appendChild(previewItem);
          
          previewItem.querySelector('.set-main-btn').addEventListener('click', () => {
            setMainThumbnail(index);
          });
          
          previewItem.querySelector('.crop-btn').addEventListener('click', () => {
            openCropModal(file, index);
          });
          
          previewItem.querySelector('.remove-btn').addEventListener('click', () => {
            removeImage(index);
          });
        };
        reader.readAsDataURL(file);
      });
      
      // ì—…ë¡œë“œ ì˜ì—­ì€ í•­ìƒ í‘œì‹œ (ì‚¬ì§„ ì¶”ê°€ ê°€ëŠ¥í•˜ë„ë¡)
      uploadArea.style.display = 'flex';
      imagePreviewSection.style.display = 'block';
    }

    function setMainThumbnail(index) {
      mainThumbnailIndex = index;
      displayImagePreviews();
    }

    function removeImage(index) {
      selectedFiles.splice(index, 1);
      if (mainThumbnailIndex >= selectedFiles.length) {
        mainThumbnailIndex = Math.max(0, selectedFiles.length - 1);
      }
      displayImagePreviews();
      updatePublishButton();
    }

    function addTag(tagText) {
      const tag = tagText.trim();
      if (!tag || selectedTags.includes(tag)) return;
      
      const formattedTag = tag.startsWith('#') ? tag : `#${tag}`;
      selectedTags.push(formattedTag);
      displayTags();
      updatePublishButton();
    }

    function displayTags() {
      tagList.innerHTML = '';
      selectedTags.forEach((tag, index) => {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-item';
        tagElement.innerHTML = `
          ${tag}
          <button type="button" class="remove-tag" data-index="${index}">
            <i class="fa-solid fa-times" style="color: black;"></i>
          </button>
        `;
        
        tagElement.querySelector('.remove-tag').addEventListener('click', () => {
          selectedTags.splice(index, 1);
          displayTags();
          updatePublishButton();
        });
        
        tagList.appendChild(tagElement);
      });
    }

    function updatePublishButton() {
      const hasImages = selectedFiles.length > 0;
      publishBtn.disabled = !hasImages;
    }

    function openCropModal(file, index) {
      currentCropIndex = index;
      const reader = new FileReader();
      reader.onload = (e) => {
        cropImage.src = e.target.result;
        cropModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Cropper ì´ˆê¸°í™”
        setTimeout(() => {
          if (cropper) {
            cropper.destroy();
          }
          cropper = new Cropper(cropImage, {
            aspectRatio: 1, // ì •ì‚¬ê°í˜• ë¹„ìœ¨
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            background: false,
            modal: true,
            responsive: true,
            checkCrossOrigin: false
          });
        }, 100);
      };
      reader.readAsDataURL(file);
    }

    function closeCropModal() {
      cropModal.style.display = 'none';
      document.body.style.overflow = '';
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentCropIndex = -1;
    }

    function convertCroppedImageToWebP(quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!cropper) {
          reject(new Error('í¬ë¡­ ë„êµ¬ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
          return;
        }
        
        try {
          const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400,
            minWidth: 200,
            minHeight: 200,
            maxWidth: 800,
            maxHeight: 800,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
          });
          
          if (!canvas) {
            reject(new Error('í¬ë¡­ëœ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
            return;
          }
          
          canvas.toBlob((blob) => {
            if (blob && blob.size > 0) {
              resolve(blob);
            } else {
              reject(new Error('WebP ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ë¹ˆ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'));
            }
          }, 'image/webp', quality);
        } catch (error) {
          reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ' + error.message));
        }
      });
    }

    async function publishPost() {
      if (!currentUser || (!isAdmin && !isApprovedUser)) {
        alert('ìŠ¹ì¸ëœ ì‚¬ìš©ì ë˜ëŠ” ê´€ë¦¬ìë§Œ í¬ìŠ¤íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedFiles.length === 0) {
        alert('ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      publishBtn.disabled = true;
      publishBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë°œí–‰ ì¤‘...';
      
      try {
        const uploadedUrls = [];
        
        // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ WebPë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const webpBlob = await convertToWebP(file);
          
          const uploadResult = await firebaseDataManager.uploadImage(webpBlob, 'img/posting');
          if (!uploadResult.success) {
            throw new Error(uploadResult.error);
          }
          uploadedUrls.push(uploadResult.url);
        }

        const postData = {
          urls: uploadedUrls,
          mainThumbnailIndex: mainThumbnailIndex,
          tags: selectedTags,
          author: currentUser.displayName || currentUser.email.split('@')[0],
          uploadedBy: currentUser.uid,
          isMultiImage: uploadedUrls.length > 1
        };
        
        const result = await firebaseDataManager.addPhoto(postData);
        
        if (result.success) {
          alert('í¬ìŠ¤íŒ…ì´ ì„±ê³µì ìœ¼ë¡œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.location.href = `picture.html?id=${result.id}`;
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        // console.error('í¬ìŠ¤íŒ… ë°œí–‰ ì˜¤ë¥˜:', error);
        alert('í¬ìŠ¤íŒ… ë°œí–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> ë°œí–‰í•˜ê¸°';
      }
    }

    async function checkUserPermissions() {
      if (!currentUser) {
        isAdmin = false;
        isApprovedUser = false;
        return;
      }
      
      try {
        const memberRef = firebaseDataManager.getDocRef('members', currentUser.uid);
        const memberSnap = await firebaseDataManager.getDocument(memberRef);
        
        if (memberSnap.exists()) {
          const memberData = memberSnap.data();
          isApprovedUser = memberData.status === 'approved';
        } else {
          isApprovedUser = false;
        }
        
        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        isAdmin = await firebaseDataManager.isAdmin(currentUser.uid);
        
      } catch (error) {
        // console.error('ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ì˜¤ë¥˜:', error);
        isAdmin = false;
        isApprovedUser = false;
      }
    }

    async function initializePage() {
      if (typeof firebaseDataManager === 'undefined') {
        // console.error('firebaseDataManagerê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        setTimeout(initializePage, 1000);
        return;
      }
      
      // í˜„ì¬ ì‚¬ìš©ì í™•ì¸
      const currentUserCheck = firebaseDataManager.getCurrentUser();
      if (currentUserCheck) {
        currentUser = currentUserCheck;
        await checkUserPermissions();
        
        if (isAdmin || isApprovedUser) {
          postingSection.style.display = 'block';
          permissionSection.style.display = 'none';
        } else {
          postingSection.style.display = 'none';
          permissionSection.style.display = 'block';
        }
      } else {
        postingSection.style.display = 'none';
        permissionSection.style.display = 'block';
      }
    }

    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      handleFileSelection(files);
    });
    
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleFileSelection(files);
    });
    
    tagInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag(tagInput.value);
        tagInput.value = '';
      }
    });
    
    publishBtn.addEventListener('click', publishPost);

    // í¬ë¡­ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    cropModalClose.addEventListener('click', closeCropModal);
    cropCancel.addEventListener('click', closeCropModal);
    
    cropConfirm.addEventListener('click', async () => {
      if (!cropper || currentCropIndex === -1) return;
      
      cropConfirm.disabled = true;
      cropConfirm.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
      
      try {
        // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ WebPë¡œ ë³€í™˜
        const webpBlob = await convertCroppedImageToWebP();
        
        // File ê°ì²´ë¡œ ë³€í™˜
        const croppedFile = new File([webpBlob], `cropped_${Date.now()}.webp`, {
          type: 'image/webp'
        });
        
        // ê¸°ì¡´ íŒŒì¼ì„ í¬ë¡­ëœ íŒŒì¼ë¡œ êµì²´
        selectedFiles[currentCropIndex] = croppedFile;
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        displayImagePreviews();
        
        closeCropModal();
        alert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ í¬ë¡­ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
      } catch (error) {
        alert('ì´ë¯¸ì§€ í¬ë¡­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        cropConfirm.disabled = false;
        cropConfirm.innerHTML = 'ì ìš©';
      }
    });
    
    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    cropModal.addEventListener('click', (e) => {
      if (e.target === cropModal) {
        closeCropModal();
      }
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cropModal.style.display === 'flex') {
        closeCropModal();
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë¡œê·¸ í•œë„ ì´ˆê³¼ë¡œ ì£¼ì„ì²˜ë¦¬)
      // if (typeof firebaseDataManager !== 'undefined') {
      //   try {
      //     await firebaseDataManager.initSecurity();
      //   } catch (error) {
      //     // ë³´ì•ˆ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ í˜ì´ì§€ëŠ” ì •ìƒ ì‘ë™
      //   }
      // }
      
      setTimeout(initializePage, 500);
    });
  </script>
</body>
</html>
