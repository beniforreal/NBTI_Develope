<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NBTI ê¸¸ë“œ - ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</title>
  <meta name="color-scheme" content="dark light">
  
  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
  <link rel="manifest" href="./site.webmanifest">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nbti.kro.kr/">
  <meta property="og:title" content="NBTI ê¸¸ë“œ - ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„">
  <meta property="og:description" content="ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„ì˜ NBTI ê¸¸ë“œ ê³µì‹ ì›¹ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. ê¸¸ë“œì›ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¦ê±°ìš´ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!">
  <meta property="og:image" content="https://nbti.kro.kr/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NBTI ê¸¸ë“œ">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://nbti.kro.kr/">
  <meta property="twitter:title" content="NBTI ê¸¸ë“œ - ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„">
  <meta property="twitter:description" content="ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„ì˜ NBTI ê¸¸ë“œ ê³µì‹ ì›¹ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. ê¸¸ë“œì›ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¦ê±°ìš´ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!">
  <meta property="twitter:image" content="https://nbti.kro.kr/img/og-image.png">
  
  <!-- ê¸°íƒ€ ë©”íƒ€ íƒœê·¸ -->
  <meta name="description" content="ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„ì˜ NBTI ê¸¸ë“œ ê³µì‹ ì›¹ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. ê¸¸ë“œì›ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¦ê±°ìš´ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!">
  <meta name="keywords" content="ë§ˆë¹„ë…¸ê¸°, ëª¨ë°”ì¼, ë˜ì»¨ì„œë²„, NBTI, ê¸¸ë“œ, ê²Œì„, ì»¤ë®¤ë‹ˆí‹°">
  <meta name="author" content="NBTI ê¸¸ë“œ">
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="./styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module" src="./js/firebase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/supabase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/firebase-data-manager.js?v=1.0.0"></script>
  <script src="./js/header-component.js?v=1.0.0"></script>
  <script src="./js/footer-component.js?v=1.0.0"></script>
</head>
<body>
  <!-- í—¤ë”ëŠ” í—¤ë” ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <!-- <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">NBTI ê¸¸ë“œ</h1> -->
    </div>
  </section>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="main-content">
    <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ (ì „ì²´ ë„ˆë¹„) -->
    <div class="notice-snippet" id="noticeSnippet">
      <div class="notice-snippet-header">
        <h2 class="notice-snippet-title">
          <i class="fa-solid fa-bullhorn"></i>
          ê³µì§€ì‚¬í•­
        </h2>
        <a href="notice.html" class="notice-snippet-more">ë”ë³´ê¸°</a>
      </div>
      <div class="notice-snippet-list" id="noticeSnippetList">
        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <!-- ì‚¬ì§„ì²©ê³¼ ê¸¸ë“œì› ì„¹ì…˜ (ê·¸ë¦¬ë“œ) -->
    <div class="content-sections-container">
      <!-- ì‚¬ì§„ì²© ì„¹ì…˜ -->
      <section class="content-section photo-section">
        <div class="section-header">
          <h2 class="section-title">
            <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="section-icon">
            ì‚¬ì§„ì²©
          </h2>
        </div>
        
        <div class="photo-grid" id="photoGrid">
          <!-- ì‚¬ì§„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <a href="./picture.html" class="more-btn">ë” ë§ì€ ì‚¬ì§„ ë³´ê¸°</a>
      </section>

      <!-- ê¸¸ë“œì› ì„¹ì…˜ -->
      <section class="content-section member-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ‘¥ ê¸¸ë“œì›</h2>
        </div>
        
        <div class="member-grid" id="memberGrid">
          <!-- ê¸¸ë“œì› ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <a href="./members.html" class="more-btn">NBTigramìœ¼ë¡œ ì´ë™</a>
      </section>
    </div>
  </main>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="login-modal">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h2>ê¸¸ë“œì› ë¡œê·¸ì¸</h2>
        <button class="login-modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="login-modal-body">
        <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <button type="button" class="btn btn-google" id="googleLoginBtn">
          <i class="fab fa-google"></i>
          Googleë¡œ ë¡œê·¸ì¸
        </button>
      </div>
    </div>
  </div>

  <script>
    async function loadPhotoPreview() {
      const photoGrid = document.getElementById('photoGrid');
      
      try {
        const photos = await firebaseDataManager.loadPhotos();
        const recentPhotos = photos
          .sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt))
          .slice(0, 8);
        
        if (recentPhotos.length === 0) {
          photoGrid.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          for (const photo of recentPhotos) {
            const photoCard = await createPhotoCard(photo);
            photoGrid.appendChild(photoCard);
          }
        }
      } catch (e) {
        // console.error('ì‚¬ì§„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        photoGrid.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 40px;">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    async function createPhotoCard(photo) {
      const card = document.createElement('div');
      card.className = 'photo-card';
      
      const imageUrls = photo.urls || (photo.url ? [photo.url] : []);
      const mainThumbnailIndex = photo.mainThumbnailIndex || 0;
      const mainImage = imageUrls[mainThumbnailIndex] || imageUrls[0];
      const isMultiImage = photo.isMultiImage || imageUrls.length > 1;
      
      function formatDate(timestamp) {
        if (!timestamp) return '';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        } catch (e) {
          return '';
        }
      }
      
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // DBì—ì„œ ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      let authorName = photo.author || '';
      try {
        if (photo.uploadedBy) {
          const memberRef = firebaseDataManager.getDocRef('members', photo.uploadedBy);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        }
      } catch (error) {
        // DBì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ author ì‚¬ìš©
      }
      
      card.innerHTML = `
        <div class="photo-thumb">
          <img src="${mainImage}" alt="í¬ìŠ¤íŒ…" loading="lazy">
          ${isMultiImage ? `<div class="multi-image-indicator"><i class="fa-solid fa-images"></i></div>` : ""}
        </div>
        <div class="photo-meta">
          <div class="photo-info">
            <span class="author">${escapeHtml(authorName)}</span>
            <span class="date">${formatDate(photo.updatedAt || photo.createdAt)}</span>
            ${isMultiImage ? `<span class="image-count"><i class="fa-solid fa-images"></i> ${imageUrls.length}</span>` : ''}
          </div>
        </div>
      `;
      
      // ì „ì²´ ì¹´ë“œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      card.style.cursor = 'pointer';
      card.addEventListener('click', () => {
        window.location.href = `picture.html?id=${photo.id}`;
      });
      
      return card;
    }
    
    async function loadMemberPreview() {
      const memberGrid = document.getElementById('memberGrid');
      
      try {
        const members = await firebaseDataManager.loadMembers();
        const recentMembers = members
          .filter(member => member.status === 'approved')
          .slice(0, 22);
        
        if (recentMembers.length === 0) {
          memberGrid.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">ë“±ë¡ëœ ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          recentMembers.forEach(member => {
            const memberCard = createMemberCard(member);
            memberGrid.appendChild(memberCard);
          });
        }
      } catch (e) {
        // console.error('ê¸¸ë“œì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        memberGrid.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 40px;">ê¸¸ë“œì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    async function loadNoticePreview() {
      const noticeSnippetList = document.getElementById('noticeSnippetList');
      
      try {
        const notices = await firebaseDataManager.loadNotices();
        const recentNotices = notices.slice(0, 3);
        
        if (recentNotices.length === 0) {
          noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          for (const notice of recentNotices) {
            const noticeItem = await createNoticeSnippetItem(notice);
            noticeSnippetList.appendChild(noticeItem);
          }
        }
      } catch (e) {
        // console.error('ê³µì§€ì‚¬í•­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    async function createNoticeSnippetItem(notice) {
      const item = document.createElement('div');
      item.className = 'notice-snippet-item';
      
      function formatDate(timestamp) {
        if (!timestamp) return '';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return date.toLocaleDateString('ko-KR', {
            month: '2-digit',
            day: '2-digit'
          });
        } catch (e) {
          return '';
        }
      }
      
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      const isImportant = notice.isImportant || false;
      
      // ì‘ì„±ì ì´ë¦„ì„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
      let authorName = notice.author; // ê¸°ë³¸ê°’
      try {
        if (notice.createdBy) {
          const memberRef = firebaseDataManager.getDocRef('members', notice.createdBy);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        }
      } catch (error) {
        // console.error('ì‘ì„±ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
      
      item.innerHTML = `
        <h4 class="notice-snippet-item-title ${isImportant ? 'important' : ''}">
          ${isImportant ? '<i class="fa-solid fa-exclamation-triangle"></i>' : ''}
          ${escapeHtml(notice.title)}
        </h4>
        <div class="notice-snippet-item-meta">
          <span>${escapeHtml(authorName)}</span>
          <span>${formatDate(notice.createdAt)}</span>
        </div>
      `;
      
      item.addEventListener('click', () => {
        window.location.href = 'notice.html';
      });
      
      return item;
    }
    
    function createMemberCard(member) {
      const card = document.createElement('div');
      card.className = 'member-card';
      
      const coverStyle = member.cover ? 
        `background-image: url('${member.cover}')` : 
        `background-image: url('img/cover.webp')`;
      
      const tagsHtml = member.tags && member.tags.length > 0 ? 
        member.tags.map(tag => `<span class="member-tag">${utils.escapeHtml(tag)}</span>`).join('') : 
        '';
      
      card.innerHTML = `
        <div class="member-cover" style="${coverStyle}">
        </div>
        <div class="member-info">
          <div class="member-name-mbti">
            <h3 class="member-name">${utils.escapeHtml(member.name)}</h3>
            <span class="member-mbti">${utils.escapeHtml(member.mbti || 'MBTI ë¯¸ì„¤ì •')}</span>
          </div>
          <p class="member-role">${utils.escapeHtml(member.role || 'ê¸¸ë“œì›')}</p>
          ${tagsHtml ? `<div class="member-tags">${tagsHtml}</div>` : ''}
          ${member.bio ? `<p class="member-bio">${utils.escapeHtml(member.bio)}</p>` : ''}
        </div>
      `;
      return card;
    }
    
    async function initializePage() {
      try {
        await Promise.all([
          loadPhotoPreview(),
          loadMemberPreview(),
          loadNoticePreview()
        ]);
      } catch (error) {
        // console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
      }
    }

    const headerComponent = new HeaderComponent();
    
    // í—¤ë” ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” í™•ì¸
    setTimeout(() => {
      if (headerComponent && typeof headerComponent.updateLoginButton === 'function') {
        headerComponent.updateLoginButton();
      }
    }, 1000);
    
    let currentUser = null;
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    function openLoginModal() {
      loginModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeLoginModal() {
      loginModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    googleLoginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const result = await firebaseDataManager.signInWithGoogle();
        if (result.success) {
          currentUser = result.user;
          closeLoginModal();
          
          await checkUserStatusAndRedirect();
          // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
      } catch (error) {
        // console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    loginModalClose.addEventListener('click', closeLoginModal);
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') {
        closeLoginModal();
      }
    });

    async function checkUserStatusAndRedirect() {
      if (!currentUser) return;
      
      try {
        const memberRef = firebaseDataManager.getDocRef('members', currentUser.uid);
        const memberSnap = await firebaseDataManager.getDocument(memberRef);
        
        if (memberSnap.exists()) {
          const memberData = memberSnap.data();
          const status = memberData.status || 'pending';
          
          if (status === 'approved') {
          } else {
            alert('â³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.\n\nì „ì‚¬ë„ë¡œë¡±ì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.\n\nìŠ¹ì¸ í›„ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }
        } else {
          alert('â³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.\n\nì „ì‚¬ë„ë¡œë¡±ì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.\n\nìŠ¹ì¸ í›„ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        // console.error('ì‚¬ìš©ì ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        alert('â³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.\n\nì „ì‚¬ë„ë¡œë¡±ì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.');
      }
    }

    function checkLoginStatus() {
      if (typeof firebaseDataManager !== 'undefined') {
        const currentUserCheck = firebaseDataManager.getCurrentUser();
        if (currentUserCheck) {
          currentUser = currentUserCheck;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë¡œê·¸ í•œë„ ì´ˆê³¼ë¡œ ì£¼ì„ì²˜ë¦¬)
      // if (typeof firebaseDataManager !== 'undefined') {
      //   try {
      //     await firebaseDataManager.initSecurity();
      //   } catch (error) {
      //     // ë³´ì•ˆ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ í˜ì´ì§€ëŠ” ì •ìƒ ì‘ë™
      //   }
      // }
      
      initializePage();
      checkLoginStatus();
    });
  </script>
</body>
</html>
