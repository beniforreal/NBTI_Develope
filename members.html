<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê¸¸ë“œì› - NBTI ê¸¸ë“œ</title>
  <meta name="color-scheme" content="dark light">
  
  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
  <link rel="manifest" href="./site.webmanifest">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nbti.kro.kr/members.html">
  <meta property="og:title" content="ê¸¸ë“œì› - NBTI ê¸¸ë“œ">
  <meta property="og:description" content="NBTI ê¸¸ë“œì˜ ë©‹ì§„ ê¸¸ë“œì›ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”! í•¨ê»˜ ëª¨í—˜ì„ ë– ë‚˜ìš”!">
  <meta property="og:image" content="https://nbti.kro.kr/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NBTI ê¸¸ë“œ">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://nbti.kro.kr/members.html">
  <meta property="twitter:title" content="ê¸¸ë“œì› - NBTI ê¸¸ë“œ">
  <meta property="twitter:description" content="NBTI ê¸¸ë“œì˜ ë©‹ì§„ ê¸¸ë“œì›ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”! í•¨ê»˜ ëª¨í—˜ì„ ë– ë‚˜ìš”!">
  <meta property="twitter:image" content="https://nbti.kro.kr/img/og-image.png">
  
  <!-- ê¸°íƒ€ ë©”íƒ€ íƒœê·¸ -->
  <meta name="description" content="NBTI ê¸¸ë“œì˜ ë©‹ì§„ ê¸¸ë“œì›ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”! í•¨ê»˜ ëª¨í—˜ì„ ë– ë‚˜ìš”!">
  <meta name="keywords" content="ë§ˆë¹„ë…¸ê¸°, ëª¨ë°”ì¼, ë˜ì»¨ì„œë²„, NBTI, ê¸¸ë“œ, ê¸¸ë“œì›, ì»¤ë®¤ë‹ˆí‹°">
  <meta name="author" content="NBTI ê¸¸ë“œ">
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="./styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module" src="./js/firebase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/supabase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/firebase-data-manager.js?v=1.0.0"></script>
  <script src="./js/header-component.js?v=1.0.0"></script>
  <script src="./js/footer-component.js?v=1.0.0"></script>
</head>
<body>
  <!-- í—¤ë”ëŠ” í—¤ë” ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <!-- <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">NBTI ê¸¸ë“œ</h1> -->
    </div>
  </section>

    <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
    <div class="notice-snippet" id="noticeSnippet">
      <div class="notice-snippet-header">
        <h2 class="notice-snippet-title">
          <i class="fa-solid fa-bullhorn"></i>
          ê³µì§€ì‚¬í•­
        </h2>
        <a href="notice.html" class="notice-snippet-more">ë”ë³´ê¸°</a>
      </div>
      <div class="notice-snippet-list" id="noticeSnippetList">
        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>

  <div class="members-container">
    <div class="page-header">
      <div class="page-title-row">
        <h1>NBTigram</h1>
      </div>
      <nav class="toolbar">
        <button class="btn" id="addMember" style="display:none">ê¸¸ë“œì› ì¶”ê°€</button>
      </nav>
    </div>

    <section id="grid" class="members-grid"></section>
  </div>


  <template id="cardTmpl">
    <article class="card">
      <div class="cover">
        <span class="cover-placeholder" style="opacity:.5">ì»¤ë²„ ì—†ìŒ</span>
        <div class="cover-upload-icon" style="display:none">
          <input type="file" class="cover-file-input" accept="image/*" style="display:none">
          <button class="cover-upload-btn" title="ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ">ğŸ“·</button>
        </div>
      </div>
      <div class="meta">
        <div class="member-name-mbti">
          <div class="member-name-mbti-left">
            <h3 class="title"></h3>
            <span class="mbti"></span>
          </div>
          <p class="role"></p>
        </div>

        <div class="member-tags"></div>
        <p class="bio"></p>
        <div class="row" style="gap:6px;margin-top:10px;flex-wrap:wrap">
          <a class="pill link" target="_blank" style="display:none">ì›ë³¸</a>
        </div>
      </div>
    </article>
  </template>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="login-modal">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h2>ê¸¸ë“œì› ë¡œê·¸ì¸</h2>
        <button class="login-modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="login-modal-body">
        <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <button type="button" class="btn btn-google" id="googleLoginBtn">
          <i class="fab fa-google"></i>
          Googleë¡œ ë¡œê·¸ì¸
        </button>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const cardTmpl = document.getElementById('cardTmpl');
    const addMember = document.getElementById('addMember');

    async function loadMembers(){
      try{
        if (typeof firebaseDataManager === 'undefined') {
          return [];
        }
        return await firebaseDataManager.loadMembers();
      }catch(e){ 
        // console.error('ê¸¸ë“œì› ë¡œë“œ ì‹¤íŒ¨:', e);
        return []; 
      }
    }
    
    const utils = {
      formatDate: (timestamp) => {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      },
      escapeHtml: (text) => {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };
    
    function fmtDate(ts){ 
      return utils.formatDate(ts); 
    }
    
    function escapeHtml(s){ 
      return utils.escapeHtml(s); 
    }

    async function loadNoticePreview() {
      const noticeSnippetList = document.getElementById('noticeSnippetList');
      
      try {
        const notices = await firebaseDataManager.loadNotices();
        const recentNotices = notices.slice(0, 3);
        
        if (recentNotices.length === 0) {
          noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          for (const notice of recentNotices) {
            const noticeItem = await createNoticeSnippetItem(notice);
            noticeSnippetList.appendChild(noticeItem);
          }
        }
      } catch (e) {
        // console.error('ê³µì§€ì‚¬í•­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    async function createNoticeSnippetItem(notice) {
      const item = document.createElement('div');
      item.className = 'notice-snippet-item';
      
      function formatDate(timestamp) {
        if (!timestamp) return '';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return date.toLocaleDateString('ko-KR', {
            month: '2-digit',
            day: '2-digit'
          });
        } catch (e) {
          return '';
        }
      }
      
      const isImportant = notice.isImportant || false;
      
      // ì‘ì„±ì ì´ë¦„ì„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
      let authorName = notice.author; // ê¸°ë³¸ê°’
      try {
        if (notice.createdBy) {
          const memberRef = firebaseDataManager.getDocRef('members', notice.createdBy);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        }
      } catch (error) {
        // console.error('ì‘ì„±ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
      
      item.innerHTML = `
        <h4 class="notice-snippet-item-title ${isImportant ? 'important' : ''}">
          ${isImportant ? '<i class="fa-solid fa-exclamation-triangle"></i>' : ''}
          ${utils.escapeHtml(notice.title)}
        </h4>
        <div class="notice-snippet-item-meta">
          <span>${utils.escapeHtml(authorName)}</span>
          <span>${formatDate(notice.createdAt)}</span>
        </div>
      `;
      
      item.addEventListener('click', () => {
        window.location.href = 'notice.html';
      });
      
      return item;
    }

    async function render(){
      const members = await loadMembers();

      grid.innerHTML = "";
      for(const m of members){
        const node = cardTmpl.content.cloneNode(true);
        const card = node.querySelector('.card');
        const cover = node.querySelector('.cover');
        const coverPlaceholder = node.querySelector('.cover-placeholder');
        const ttl = node.querySelector('.title');
        const mbti = node.querySelector('.mbti');
        const role = node.querySelector('.role');
        const memberTags = node.querySelector('.member-tags');
        const bio = node.querySelector('.bio');
        const link = node.querySelector('.link');
        const coverUploadIcon = node.querySelector('.cover-upload-icon');
        const coverFileInput = node.querySelector('.cover-file-input');
        const coverUploadBtn = node.querySelector('.cover-upload-btn');

        ttl.textContent = m.name;
        mbti.textContent = m.mbti || "MBTI ë¯¸ì„¤ì •";
        role.textContent = m.role || "ê¸¸ë“œì›";
        bio.textContent = m.bio || "";
        
        if (m.tags && m.tags.length > 0) {
          memberTags.innerHTML = m.tags.map(tag => `<span class="member-tag">${utils.escapeHtml(tag)}</span>`).join('');
        } else {
          memberTags.innerHTML = '';
        }
        
        const coverStyle = m.cover ? 
          `background-image: url('${m.cover}')` : 
          `background-image: url('img/cover.webp')`;
        cover.style.cssText = coverStyle;
        
        if (m.cover) {
          coverPlaceholder.style.display = 'none';
        } else {
          coverPlaceholder.style.display = 'block';
        }
        
        coverUploadIcon.style.display = 'none';

        coverUploadBtn.onclick = () => {
          coverFileInput.click();
        };


        grid.appendChild(node);
      }
    }

    addMember.style.display = 'none';

    const headerComponent = new HeaderComponent();
    
    // í—¤ë” ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” í™•ì¸
    setTimeout(() => {
      if (headerComponent && typeof headerComponent.updateLoginButton === 'function') {
        headerComponent.updateLoginButton();
      }
    }, 1000);
    
    let currentUser = null;
    const loginModal = document.getElementById('loginModal');
    const loginModalClose = document.getElementById('loginModalClose');
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    function openLoginModal() {
      loginModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeLoginModal() {
      loginModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    googleLoginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      try {
        const result = await firebaseDataManager.signInWithGoogle();
        if (result.success) {
          currentUser = result.user;
          closeLoginModal();
          
          // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
      } catch (error) {
        // console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    loginModalClose.addEventListener('click', closeLoginModal);
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') {
        closeLoginModal();
      }
    });

    function checkAuthState() {
      if (typeof firebaseDataManager === 'undefined') {
        return;
      }
      
      const currentUserCheck = firebaseDataManager.getCurrentUser();
      if (currentUserCheck) {
        currentUser = currentUserCheck;
      } else {
        currentUser = null;
      }
      
      firebaseDataManager.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
        } else {
          currentUser = null;
        }
      });
    }

    async function initializePage() {
      try {
        if (typeof firebaseDataManager === 'undefined') {
          setTimeout(initializePage, 1000);
          return;
        }
        
        await Promise.all([
          render(),
          loadNoticePreview()
        ]);
        checkAuthState();
      } catch (error) {
        // console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
      }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      // ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë¡œê·¸ í•œë„ ì´ˆê³¼ë¡œ ì£¼ì„ì²˜ë¦¬)
      // if (typeof firebaseDataManager !== 'undefined') {
      //   try {
      //     await firebaseDataManager.initSecurity();
      //   } catch (error) {
      //     // ë³´ì•ˆ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ í˜ì´ì§€ëŠ” ì •ìƒ ì‘ë™
      //   }
      // }
      
      setTimeout(initializePage, 500);
    });
  </script>
</body>
</html>
