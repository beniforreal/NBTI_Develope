<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‚¬ì§„ì²© - NBTI ê¸¸ë“œ</title>
  <meta name="color-scheme" content="dark light">
  
  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
  <link rel="manifest" href="./site.webmanifest">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nbti.kro.kr/picture.html">
  <meta property="og:title" content="ì‚¬ì§„ì²© - NBTI ê¸¸ë“œ">
  <meta property="og:description" content="NBTI ê¸¸ë“œì›ë“¤ì˜ ì†Œì¤‘í•œ ì¶”ì–µê³¼ ëª¨í—˜ ì‚¬ì§„ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!">
  <meta property="og:image" content="https://nbti.kro.kr/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NBTI ê¸¸ë“œ">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://nbti.kro.kr/picture.html">
  <meta property="twitter:title" content="ì‚¬ì§„ì²© - NBTI ê¸¸ë“œ">
  <meta property="twitter:description" content="NBTI ê¸¸ë“œì›ë“¤ì˜ ì†Œì¤‘í•œ ì¶”ì–µê³¼ ëª¨í—˜ ì‚¬ì§„ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!">
  <meta property="twitter:image" content="https://nbti.kro.kr/img/og-image.png">
  
  <!-- ê¸°íƒ€ ë©”íƒ€ íƒœê·¸ -->
  <meta name="description" content="NBTI ê¸¸ë“œì›ë“¤ì˜ ì†Œì¤‘í•œ ì¶”ì–µê³¼ ëª¨í—˜ ì‚¬ì§„ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!">
  <meta name="keywords" content="ë§ˆë¹„ë…¸ê¸°, ëª¨ë°”ì¼, ë˜ì»¨ì„œë²„, NBTI, ê¸¸ë“œ, ì‚¬ì§„ì²©, ì¶”ì–µ">
  <meta name="author" content="NBTI ê¸¸ë“œ">
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="./styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module" src="./js/firebase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/supabase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/firebase-data-manager.js?v=1.0.0"></script>
  <script src="./js/header-component.js?v=1.0.0"></script>
  <script src="./js/footer-component.js?v=1.0.0"></script>
</head>
<body>
  <!-- í—¤ë”ëŠ” í—¤ë” ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <!-- <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">NBTI ê¸¸ë“œ</h1> -->
    </div>
  </section>

    <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
    <div class="notice-snippet" id="noticeSnippet">
      <div class="notice-snippet-header">
        <h2 class="notice-snippet-title">
          <i class="fa-solid fa-bullhorn"></i>
          ê³µì§€ì‚¬í•­
        </h2>
        <a href="notice.html" class="notice-snippet-more">ë”ë³´ê¸°</a>
      </div>
      <div class="notice-snippet-list" id="noticeSnippetList">
        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>

  <div class="members-container">
    <div class="page-header">
      <div class="page-title-row">
        <h1>
          <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="page-icon">
          ì‚¬ì§„ì²©
        </h1>
        <div class="page-actions">
          <button class="create-post-btn" id="createPostBtn" title="ìƒˆ í¬ìŠ¤íŒ…">
            <i class="fa-solid fa-plus"></i>
            <span>ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸°</span>
          </button>
          <div class="search">
            <input id="q" placeholder="íƒœê·¸ ì…ë ¥">
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
        </div>
      </div>
    </div>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty" hidden>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ <b>ì‚¬ì§„ ì—…ë¡œë“œ</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</div>
  </div>


  <!-- í¬ìŠ¤íŒ… ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="dlg" class="posting-dialog">
    <div class="posting-header">
      <h3>ìƒˆ í¬ìŠ¤íŒ…</h3>
      <button type="button" class="close-btn" id="cancelBtn">&times;</button>
        </div>
    <form method="dialog" id="form" class="posting-form">
      <div class="posting-content">
        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ -->
        <div class="image-upload-section">
          <div class="image-upload-area" id="imageUploadArea">
            <div class="upload-placeholder">
              <i class="fa-solid fa-images"></i>
              <p>ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
              <span>ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥</span>
        </div>
            <input type="file" id="file" accept="image/*" multiple style="display: none;">
        </div>
          <div class="image-preview-container" id="imagePreviewContainer"></div>
      </div>
        
        <!-- í…ìŠ¤íŠ¸ ì‘ì„± ì˜ì—­ -->
        <div class="text-input-section">
          <div class="author-info">
            <div class="author-avatar">
              <span id="authorInitial">U</span>
            </div>
            <span class="author-name" id="authorName">ì‚¬ìš©ì</span>
          </div>
          <textarea id="caption" placeholder="ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìˆë‚˜ìš”?" rows="4"></textarea>
          <div class="character-count">
            <span id="charCount">0</span>/2200
          </div>
        </div>
        
        <!-- ì¶”ê°€ ì˜µì…˜ -->
        <div class="posting-options">
          <div class="option-row">
            <label for="location">ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ìœ„ì¹˜ ì¶”ê°€ (ì„ íƒì‚¬í•­)">
          </div>
          <div class="option-row">
            <label for="tags">íƒœê·¸</label>
            <input type="text" id="tags" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: #ê¸¸ë“œ #ëª¨ì„)">
          </div>
        </div>
      </div>
      
      <div class="posting-footer">
        <button class="btn btn-secondary" type="button" id="cancelBtn2">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="submitBtn" type="submit">
          <i class="fa-solid fa-paper-plane"></i>
          ê³µìœ í•˜ê¸°
        </button>
      </div>
    </form>
  </dialog>

  <!-- ì„¸ë¡œ ê¸´ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="detailModal" class="detail-modal">
    <div class="detail-content">
      <!-- ì‘ì„±ì ì •ë³´ -->
      <div class="detail-header">
        <div class="detail-author">
          <span class="author-name" id="detailAuthorName">ì‘ì„±ì</span>
          <span class="post-date" id="detailPostDate">ë‚ ì§œ</span>
      </div>
        <div class="detail-header-actions">
          <button id="detailDelete" class="detail-delete-btn" style="display:none">
            <i class="fa-solid fa-trash"></i>
          </button>
          <button id="detailClose" class="detail-close-btn">
            <i class="fa-solid fa-times"></i>
          </button>
          </div>
          </div>
      
      <!-- ì´ë¯¸ì§€ ìŠ¤í¬ë¡¤ ì˜ì—­ -->
      <div class="detail-images" id="detailImages">
        <!-- ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        
        <!-- ì¢‹ì•„ìš” ì• ë‹ˆë©”ì´ì…˜ í•˜íŠ¸ë“¤ -->
        <div class="like-animation-container" id="likeAnimationContainer">
          <!-- ì• ë‹ˆë©”ì´ì…˜ í•˜íŠ¸ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
          </div>
      
      <!-- íƒœê·¸ ì˜ì—­ -->
      <div class="detail-tags" id="detailTags">
        <div class="detail-tags-content">
          <!-- íƒœê·¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- ì¢‹ì•„ìš”/ê³µìœ  ë²„íŠ¼ ì˜ì—­ -->
        <div class="detail-actions">
          <button class="detail-like-btn" id="detailLikeBtn">
            <i class="fa-regular fa-heart"></i>
            <span class="like-count" id="likeCount">0</span>
          </button>
          <button class="detail-share-btn" id="detailShareBtn">
            <i class="fa-solid fa-share"></i>
          </button>
        </div>
          </div>
      
      <!-- ê´€ë ¨ í”¼ë“œ ì„¹ì…˜ -->
      <div class="related-posts" id="relatedPosts">
        <h3>ë‹¤ë¥¸ í¬ìŠ¤íŒ…</h3>
        <div class="related-posts-grid" id="relatedPostsGrid">
          <!-- ë‹¤ë¥¸ í”¼ë“œ ì¸ë„¤ì¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="login-modal">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h2>ê¸¸ë“œì› ë¡œê·¸ì¸</h2>
        <button class="login-modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="login-modal-body">
        <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <button type="button" class="btn btn-google" id="googleLoginBtn">
          <i class="fab fa-google"></i>
          Googleë¡œ ë¡œê·¸ì¸
        </button>
        
        <div class="login-help">
          <p>ğŸ’¡ ë¡œê·¸ì¸ ì•ˆë‚´:</p>
          <ul>
            <li>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</li>
            <li>ìŠ¹ì¸ëœ ì‚¬ìš©ìë§Œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì—…ë¡œë“œ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- í”Œë¡œíŒ… í¬ìŠ¤íŒ… ë²„íŠ¼ -->
  <div class="floating-post-btn" id="floatingPostBtn" style="display:none">
    <a href="create-post.html" class="floating-btn-link">
      <i class="fa-solid fa-plus"></i>
    </a>
  </div>

  <script>
    const utils = {
      formatDate: (timestamp) => {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      },
      escapeHtml: (text) => {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const dlg = document.getElementById('dlg');
    const openAdd = document.getElementById('openAdd');
    const form = document.getElementById('form');
    const file = document.getElementById('file');
    const captionEl = document.getElementById('caption');
    const locationEl = document.getElementById('location');
    const tagsEl = document.getElementById('tags');
    const submitBtn = document.getElementById('submitBtn');
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const charCount = document.getElementById('charCount');
    const authorName = document.getElementById('authorName');
    const authorInitial = document.getElementById('authorInitial');
    
    let selectedFiles = [];
    let imagePreviews = [];
    
    const detailModal = document.getElementById('detailModal');
    const detailTitle = document.getElementById('detailTitle');
    const detailImage = document.getElementById('detailImage');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailAuthor = document.getElementById('detailAuthor');
    const detailDate = document.getElementById('detailDate');
    const detailTags = document.getElementById('detailTags');
    const detailViewOriginal = document.getElementById('detailViewOriginal');
    const detailDelete = document.getElementById('detailDelete');
    const detailClose = document.getElementById('detailClose');
    const cancelBtn = document.getElementById('cancelBtn');
    
    
    let currentUser = null;
    let isAdmin = false;
    let isApprovedUser = false;
    let currentPostId = null;
    let currentPostLikes = [];
    let userLikedPosts = new Set();

    async function loadPhotos(){
      try{ 
        return await firebaseDataManager.loadPhotos(); 
      }
      catch(e){ 
        // console.error('ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨:', e);
        return []; 
      }
    }
    
    function fmtDate(ts){
      return utils.formatDate(ts);
    }
    async function render(filter=""){
      const items = await loadPhotos();
      const term = filter.trim().toLowerCase();
      const filtered = term ? items.filter(it=>{
        const hay = [it.title,it.subtitle,it.author,(it.tags||[]).join(",")].join(" ").toLowerCase();
        return hay.includes(term);
      }) : items;

      grid.innerHTML = "";
      if(filtered.length===0){ empty.hidden=false; return; }
      empty.hidden=true;

      for(const it of filtered.sort((a,b)=>(b.updatedAt || b.createdAt)-(a.updatedAt || a.createdAt))){
        const card = document.createElement('article'); 
        card.className = "midjourney-card";
        
        const imageUrls = it.urls || (it.url ? [it.url] : []);
        const mainThumbnailIndex = it.mainThumbnailIndex || 0;
        const mainImage = imageUrls[mainThumbnailIndex] || imageUrls[0];
        const isMultiImage = it.isMultiImage || imageUrls.length > 1;
        
        // DBì—ì„œ ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        let authorName = it.author || "";
        try {
          if (it.uploadedBy) {
            const memberRef = firebaseDataManager.getDocRef('members', it.uploadedBy);
            const memberSnap = await firebaseDataManager.getDocument(memberRef);
            if (memberSnap.exists()) {
              const memberData = memberSnap.data();
              authorName = memberData.name || authorName;
            }
          }
        } catch (error) {
          // DBì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ author ì‚¬ìš©
        }
        
        card.innerHTML = `
          <div class="card-image" style="cursor:pointer" data-id="${it.id}">
            ${mainImage ? `<img src="${mainImage}" alt="">` : ""}
            ${isMultiImage ? `<div class="multi-image-indicator"><i class="fa-solid fa-images"></i></div>` : ""}
            <div class="image-overlay">
              <div class="overlay-left">
                <div class="tags-preview">
                  ${(it.tags||[]).slice(0,3).map(t=>`<span class="tag-pill">${utils.escapeHtml(t)}</span>`).join("")}
                  ${(it.tags||[]).length > 3 ? `<span class="more-tags">+${(it.tags||[]).length - 3}</span>` : ''}
                </div>
              </div>
              <div class="overlay-right">
                <div class="author-info-overlay">
                  <span class="author-name-overlay">${utils.escapeHtml(authorName)}</span>
                </div>
              </div>
            </div>
            ${(isAdmin || (currentUser && it.uploadedBy === currentUser.uid)) ? 
              `<button class="delete-btn-overlay" data-id="${it.id}" title="ì‚­ì œ">
                <i class="fa-solid fa-trash"></i>
              </button>` : ''}
          </div>
          <div class="card-footer">
            <div class="post-meta">
              <span class="post-date">${fmtDate(it.updatedAt || it.createdAt)}</span>
              ${isMultiImage ? `<span class="image-count"><i class="fa-solid fa-images"></i> ${imageUrls.length}</span>` : ''}
            </div>
          </div>`;
        grid.appendChild(card);
      }

      grid.querySelectorAll('.card-image').forEach(element=>{
        element.onclick = () => {
          const id = element.getAttribute('data-id');
          showDetail(id);
        };
      });

      grid.querySelectorAll('.delete-btn-overlay').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const items = await loadPhotos();
          const item = items.find(it => it.id === id);
          if (!item) return;
          
          const canDelete = isAdmin || (currentUser && item.uploadedBy === currentUser.uid);
          if (!canDelete) {
            alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          if (confirm(`ì •ë§ë¡œ '${item.title}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            try {
              const success = await firebaseDataManager.deletePhoto(id);
              if (success) {
                await render(q.value);
                alert('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            } catch (error) {
              // console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
              alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }
        };
      });
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    async function loadRelatedPosts(currentId) {
      try {
        const allItems = await loadPhotos();
        const relatedItems = allItems.filter(item => item.id !== currentId);
        
        const relatedPostsGrid = document.getElementById('relatedPostsGrid');
        relatedPostsGrid.innerHTML = '';
        
        const displayItems = relatedItems.slice(0, 6);
        
        for (const item of displayItems) {
          const imageUrls = item.urls || (item.url ? [item.url] : []);
          const mainThumbnailIndex = item.mainThumbnailIndex || 0;
          const mainImage = imageUrls[mainThumbnailIndex] || imageUrls[0];
          const isMultiImage = item.isMultiImage || imageUrls.length > 1;
          
          // DBì—ì„œ ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
          let authorName = item.author || "";
          try {
            if (item.uploadedBy) {
              const memberRef = firebaseDataManager.getDocRef('members', item.uploadedBy);
              const memberSnap = await firebaseDataManager.getDocument(memberRef);
              if (memberSnap.exists()) {
                const memberData = memberSnap.data();
                authorName = memberData.name || authorName;
              }
            }
          } catch (error) {
            // DBì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ author ì‚¬ìš©
          }
          
          const relatedPost = document.createElement('div');
          relatedPost.className = 'related-post-item';
          relatedPost.setAttribute('data-id', item.id);
          
          relatedPost.innerHTML = `
            <div class="related-post-image">
              ${mainImage ? `<img src="${mainImage}" alt="">` : ""}
              ${isMultiImage ? `<div class="related-multi-indicator"><i class="fa-solid fa-images"></i></div>` : ""}
            </div>
            <div class="related-post-info">
              <span class="related-post-author">${utils.escapeHtml(authorName)}</span>
              <span class="related-post-date">${fmtDate(item.updatedAt || item.createdAt)}</span>
            </div>
          `;
          
          relatedPost.addEventListener('click', () => {
            showDetail(item.id);
          });
          
          relatedPostsGrid.appendChild(relatedPost);
        }
        
      } catch (error) {
        // console.error('ê´€ë ¨ í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadNoticePreview() {
      const noticeSnippetList = document.getElementById('noticeSnippetList');
      
      try {
        const notices = await firebaseDataManager.loadNotices();
        const recentNotices = notices.slice(0, 3);
        
        if (recentNotices.length === 0) {
          noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          for (const notice of recentNotices) {
            const noticeItem = await createNoticeSnippetItem(notice);
            noticeSnippetList.appendChild(noticeItem);
          }
        }
      } catch (e) {
        // console.error('ê³µì§€ì‚¬í•­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        noticeSnippetList.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    async function createNoticeSnippetItem(notice) {
      const item = document.createElement('div');
      item.className = 'notice-snippet-item';
      
      function formatDate(timestamp) {
        if (!timestamp) return '';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return date.toLocaleDateString('ko-KR', {
            month: '2-digit',
            day: '2-digit'
          });
        } catch (e) {
          return '';
        }
      }
      
      const isImportant = notice.isImportant || false;
      
      // ì‘ì„±ì ì´ë¦„ì„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
      let authorName = notice.author; // ê¸°ë³¸ê°’
      try {
        if (notice.createdBy) {
          const memberRef = firebaseDataManager.getDocRef('members', notice.createdBy);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        }
      } catch (error) {
        // console.error('ì‘ì„±ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
      
      item.innerHTML = `
        <h4 class="notice-snippet-item-title ${isImportant ? 'important' : ''}">
          ${isImportant ? '<i class="fa-solid fa-exclamation-triangle"></i>' : ''}
          ${utils.escapeHtml(notice.title)}
        </h4>
        <div class="notice-snippet-item-meta">
          <span>${utils.escapeHtml(authorName)}</span>
          <span>${formatDate(notice.createdAt)}</span>
        </div>
      `;
      
      item.addEventListener('click', () => {
        window.location.href = 'notice.html';
      });
      
      return item;
    }

    async function openDetailWithRetry(photoId, retryCount = 0) {
      const maxRetries = 3;
      const items = await loadPhotos();
      const item = items.find(it => it.id === photoId);
      
      if (item) {
        showDetail(photoId);
      } else if (retryCount < maxRetries) {
        // í¬ìŠ¤íŒ…ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
        setTimeout(() => {
          openDetailWithRetry(photoId, retryCount + 1);
        }, 1000);
      } else {
        // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í•œ ê²½ìš° ì¼ë°˜ í”¼ë“œë¡œ ì´ë™
        alert('í¬ìŠ¤íŒ…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”¼ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        const url = new URL(window.location);
        url.searchParams.delete('id');
        window.history.replaceState({}, '', url);
      }
    }

    // ì¢‹ì•„ìš” ê´€ë ¨ í•¨ìˆ˜ë“¤
    async function loadPostLikes(postId) {
      try {
        const likesRef = firebaseDataManager.getCollection('post_likes');
        const q = firebaseDataManager.query(likesRef, firebaseDataManager.where('postId', '==', postId));
        const querySnapshot = await firebaseDataManager.getDocs(q);
        
        const likes = [];
        querySnapshot.forEach((doc) => {
          likes.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        return likes;
      } catch (error) {
        return [];
      }
    }

    async function loadUserLikedPosts(userId) {
      try {
        const likesRef = firebaseDataManager.getCollection('post_likes');
        const q = firebaseDataManager.query(likesRef, firebaseDataManager.where('userId', '==', userId));
        const querySnapshot = await firebaseDataManager.getDocs(q);
        
        const likedPosts = new Set();
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          likedPosts.add(data.postId);
        });
        
        return likedPosts;
      } catch (error) {
        return new Set();
      }
    }

    async function toggleLike(postId, userId) {
      try {
        const likesRef = firebaseDataManager.getCollection('post_likes');
        const q = firebaseDataManager.query(
          likesRef, 
          firebaseDataManager.where('postId', '==', postId),
          firebaseDataManager.where('userId', '==', userId)
        );
        const querySnapshot = await firebaseDataManager.getDocs(q);
        
        if (querySnapshot.empty) {
          // ì¢‹ì•„ìš” ì¶”ê°€
          await firebaseDataManager.addDoc(likesRef, {
            postId: postId,
            userId: userId,
            createdAt: firebaseDataManager.serverTimestamp()
          });
          return true; // ì¢‹ì•„ìš” ì¶”ê°€ë¨
        } else {
          // ì¢‹ì•„ìš” ì œê±°
          const likeDoc = querySnapshot.docs[0];
          await firebaseDataManager.deleteDoc(likeDoc.ref);
          return false; // ì¢‹ì•„ìš” ì œê±°ë¨
        }
      } catch (error) {
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ í˜„ì¬ ìƒíƒœë¥¼ ë°˜í™˜í•˜ì—¬ UI ì¼ê´€ì„± ìœ ì§€
        const currentLikes = await loadPostLikes(postId);
        const isCurrentlyLiked = currentLikes.some(like => like.userId === userId);
        return isCurrentlyLiked;
      }
    }

    function createLikeAnimation() {
      const container = document.getElementById('likeAnimationContainer');
      const heart = document.createElement('div');
      heart.className = 'like-heart-animation';
      heart.innerHTML = '<i class="fa-solid fa-heart"></i>';
      
      // ëœë¤ ìœ„ì¹˜ì™€ í¬ê¸°
      const size = Math.random() * 20 + 15; // 15-35px
      const x = Math.random() * 200 - 100; // -100px ~ 100px
      const rotation = Math.random() * 30 - 15; // -15ë„ ~ 15ë„
      
      heart.style.cssText = `
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) rotate(${rotation}deg);
        font-size: ${size}px;
        color: #ff6b9d;
        pointer-events: none;
        z-index: 1000;
        animation: likeHeartFloat 1.5s ease-out forwards;
      `;
      
      container.appendChild(heart);
      
      // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
      setTimeout(() => {
        if (heart.parentNode) {
          heart.parentNode.removeChild(heart);
        }
      }, 1500);
    }

    async function handleLikeClick() {
      if (!currentUser) {
        return;
      }
      
      if (!currentPostId) return;
      
      const likeBtn = document.getElementById('detailLikeBtn');
      const likeIcon = likeBtn.querySelector('i');
      const likeCountEl = document.getElementById('likeCount');
      
      // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
      likeBtn.disabled = true;
      
      // í˜„ì¬ ì¢‹ì•„ìš” ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      const currentCount = parseInt(likeCountEl.textContent) || 0;
      
      try {
        const isLiked = await toggleLike(currentPostId, currentUser.uid);
        
        if (isLiked) {
          // ì¢‹ì•„ìš” ì¶”ê°€ë¨ - ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
          userLikedPosts.add(currentPostId);
          likeIcon.className = 'fa-solid fa-heart';
          likeBtn.classList.add('liked');
          likeCountEl.textContent = currentCount + 1; // ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì¦ê°€
          createLikeAnimation();
          createLikeAnimation(); // ë‘ ê°œì˜ í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜
          setTimeout(() => createLikeAnimation(), 100); // ì„¸ ë²ˆì§¸ í•˜íŠ¸
        } else {
          // ì¢‹ì•„ìš” ì œê±°ë¨ - ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
          userLikedPosts.delete(currentPostId);
          likeIcon.className = 'fa-regular fa-heart';
          likeBtn.classList.remove('liked');
          likeCountEl.textContent = Math.max(0, currentCount - 1); // ì¹´ìš´íŠ¸ ì¦‰ì‹œ ê°ì†Œ
        }
        
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤ì œ ë°ì´í„°ì™€ ë™ê¸°í™” (ì‚¬ìš©ìì—ê²ŒëŠ” ë³´ì´ì§€ ì•ŠìŒ)
        setTimeout(async () => {
          try {
            await updateLikeDisplay();
          } catch (error) {
            // ë™ê¸°í™” ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
          }
        }, 100);
        
      } catch (error) {
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ UIë¥¼ ì›ë˜ ìƒíƒœë¡œ ë³µì›
        const currentLikes = await loadPostLikes(currentPostId);
        const isCurrentlyLiked = currentLikes.some(like => like.userId === currentUser.uid);
        
        if (isCurrentlyLiked) {
          likeIcon.className = 'fa-solid fa-heart';
          likeBtn.classList.add('liked');
          userLikedPosts.add(currentPostId);
        } else {
          likeIcon.className = 'fa-regular fa-heart';
          likeBtn.classList.remove('liked');
          userLikedPosts.delete(currentPostId);
        }
        
        
        // ì˜¤ë¥˜ ì•ŒëŒ ì œê±° - ì¡°ìš©íˆ ì²˜ë¦¬
      } finally {
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        likeBtn.disabled = false;
      }
    }

    async function updateLikeDisplay() {
      if (!currentPostId) return;
      
      try {
        const likes = await loadPostLikes(currentPostId);
        const likeCount = likes.length;
        
        // í˜„ì¬ ì‚¬ìš©ìê°€ ì´ í¬ìŠ¤íŠ¸ì— ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ í™•ì¸
        const isLiked = likes.some(like => like.userId === currentUser?.uid);
        
        const likeBtn = document.getElementById('detailLikeBtn');
        const likeCountEl = document.getElementById('likeCount');
        const likeIcon = likeBtn.querySelector('i');
        
        if (likeCountEl) {
          likeCountEl.textContent = likeCount;
        }
        
        if (likeIcon) {
          if (isLiked) {
            likeIcon.className = 'fa-solid fa-heart';
            likeBtn.classList.add('liked');
          } else {
            likeIcon.className = 'fa-regular fa-heart';
            likeBtn.classList.remove('liked');
          }
        }
        
        // userLikedPosts Setë„ ë™ê¸°í™”
        if (isLiked) {
          userLikedPosts.add(currentPostId);
        } else {
          userLikedPosts.delete(currentPostId);
        }
        
      } catch (error) {
        // ì¢‹ì•„ìš” í‘œì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
      }
    }

    async function handleShareClick() {
      const currentUrl = window.location.href;
      
      try {
        await navigator.clipboard.writeText(currentUrl);
        
        // ê³µìœ  ë²„íŠ¼ì— í”¼ë“œë°±
        const shareBtn = document.getElementById('detailShareBtn');
        const shareIcon = shareBtn.querySelector('i');
        shareIcon.className = 'fa-solid fa-check';
        shareBtn.classList.add('shared');
        
        setTimeout(() => {
          shareIcon.className = 'fa-solid fa-share';
          shareBtn.classList.remove('shared');
        }, 1500);
        
      } catch (error) {
        // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•
        const textArea = document.createElement('textarea');
        textArea.value = currentUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }
    }

    async function showDetail(id) {
      const items = await loadPhotos();
      const item = items.find(it => it.id === id);
      if (!item) return;
      
      currentPostId = id;

      // DBì—ì„œ ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      let authorName = item.author || "ì •ë³´ ì—†ìŒ";
      try {
        if (item.uploadedBy) {
          const memberRef = firebaseDataManager.getDocRef('members', item.uploadedBy);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        }
      } catch (error) {
        // DBì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ author ì‚¬ìš©
      }

      document.getElementById('detailAuthorName').textContent = authorName;
      document.getElementById('detailPostDate').textContent = fmtDate(item.updatedAt || item.createdAt);
      
      const imageUrls = item.urls || (item.url ? [item.url] : []);
      const detailImages = document.getElementById('detailImages');
      
      detailImages.innerHTML = '';
      
      imageUrls.forEach((url, index) => {
        const imageContainer = document.createElement('div');
        imageContainer.className = 'detail-image-item';
        imageContainer.innerHTML = `
          <img src="${url}" alt="ì´ë¯¸ì§€ ${index + 1}" loading="lazy">
        `;
        detailImages.appendChild(imageContainer);
      });
      
      const tagsContainer = document.getElementById('detailTags').querySelector('.detail-tags-content');
      tagsContainer.innerHTML = '';
      if (item.tags && item.tags.length > 0) {
        item.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'detail-tag-item';
          tagEl.textContent = tag;
          tagsContainer.appendChild(tagEl);
        });
      } else {
        tagsContainer.innerHTML = '<span class="no-tags">íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</span>';
      }

      await loadRelatedPosts(id);

      // ì¢‹ì•„ìš” í‘œì‹œ ì—…ë°ì´íŠ¸
      await updateLikeDisplay();

      const canDelete = isAdmin || (currentUser && item.uploadedBy === currentUser.uid);
      const detailDelete = document.getElementById('detailDelete');
      if (canDelete) {
        detailDelete.style.display = 'flex';
        detailDelete.onclick = async () => {
          if (confirm(`ì •ë§ë¡œ ì´ í¬ìŠ¤íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            try {
              const success = await firebaseDataManager.deletePhoto(id);
                if (success) {
                  await render(q.value);
                  detailModal.style.display = 'none';
                // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì œê±°
                const url = new URL(window.location);
                url.searchParams.delete('id');
                window.history.replaceState({}, '', url);
                alert('í¬ìŠ¤íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                  alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
              // console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
              alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }
        };
      } else {
        detailDelete.style.display = 'none';
      }

      detailModal.style.display = 'flex';
      
      const floatingPostBtn = document.getElementById('floatingPostBtn');
      if (floatingPostBtn) {
        floatingPostBtn.style.display = 'none';
      }
    }

    detailClose.onclick = () => {
      detailModal.style.display = 'none';
      updateUploadButtonVisibility();
      // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì œê±°
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.replaceState({}, '', url);
    };
    
    detailModal.onclick = (e) => {
      if (e.target === detailModal) {
        detailModal.style.display = 'none';
        updateUploadButtonVisibility();
        // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì œê±°
        const url = new URL(window.location);
        url.searchParams.delete('id');
        window.history.replaceState({}, '', url);
      }
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && detailModal.style.display === 'flex') {
        detailModal.style.display = 'none';
        updateUploadButtonVisibility();
        // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì œê±°
        const url = new URL(window.location);
        url.searchParams.delete('id');
        window.history.replaceState({}, '', url);
      }
    });

    // ì¢‹ì•„ìš”/ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('detailLikeBtn').addEventListener('click', handleLikeClick);
    document.getElementById('detailShareBtn').addEventListener('click', handleShareClick);


    function updateUploadButtonVisibility() {
      const floatingPostBtn = document.getElementById('floatingPostBtn');
      if (isAdmin || isApprovedUser) {
        floatingPostBtn.style.display = 'block';
      } else {
        floatingPostBtn.style.display = 'none';
      }
    }

    q.addEventListener('input', ()=>render(q.value));

    dlg.addEventListener('click', (e) => {
      if (e.target === dlg) {
        dlg.close();
      }
    });

    dlg.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dlg.close();
      }
    });

    cancelBtn.addEventListener('click', () => {
      dlg.close();
    });
    
    const cancelBtn2 = document.getElementById('cancelBtn2');
    cancelBtn2.addEventListener('click', () => {
      dlg.close();
    });

    imageUploadArea.addEventListener('click', () => {
      file.click();
    });

    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.classList.add('drag-over');
    });

    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.classList.remove('drag-over');
    });

    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      handleFileSelection(files);
    });

    file.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleFileSelection(files);
    });

    captionEl.addEventListener('input', () => {
      const count = captionEl.value.length;
      charCount.textContent = count;
      
      if (count > 2200) {
        charCount.style.color = '#ff4444';
      } else if (count > 2000) {
        charCount.style.color = '#ff8800';
      } else {
        charCount.style.color = '#666';
      }
    });

    function handleFileSelection(files) {
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      
      if (imageFiles.length === 0) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedFiles.length + imageFiles.length > 10) {
        alert('ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      selectedFiles = [...selectedFiles, ...imageFiles];
      displayImagePreviews();
    }

    function displayImagePreviews() {
      imagePreviewContainer.innerHTML = '';
      imagePreviews = [];
      
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°">
            <button type="button" class="remove-image" data-index="${index}">
              <i class="fa-solid fa-times"></i>
            </button>
          `;
          
          imagePreviewContainer.appendChild(preview);
          imagePreviews.push(e.target.result);
          
          preview.querySelector('.remove-image').addEventListener('click', () => {
            removeImage(index);
          });
        };
        reader.readAsDataURL(file);
      });
      
      if (selectedFiles.length > 0) {
        imageUploadArea.style.display = 'none';
      } else {
        imageUploadArea.style.display = 'flex';
      }
    }

    function removeImage(index) {
      selectedFiles.splice(index, 1);
      displayImagePreviews();
    }

    function convertToWebP(file, quality = 0.8) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          canvas.toBlob((blob) => {
            resolve(blob);
          }, 'image/webp', quality);
        };
        
        img.src = URL.createObjectURL(file);
      });
    }

    function resetPostingForm() {
      selectedFiles = [];
      imagePreviews = [];
      imagePreviewContainer.innerHTML = '';
      imageUploadArea.style.display = 'flex';
      captionEl.value = '';
      locationEl.value = '';
      tagsEl.value = '';
      charCount.textContent = '0';
      charCount.style.color = '#666';
    }

    function updateAuthorInfo() {
      if (currentUser) {
        const name = currentUser.displayName || currentUser.email.split('@')[0];
        authorName.textContent = name;
        authorInitial.textContent = name.charAt(0).toUpperCase();
      }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (!isAdmin && !isApprovedUser) {
        alert('ìŠ¹ì¸ëœ ì‚¬ìš©ì ë˜ëŠ” ê´€ë¦¬ìë§Œ í¬ìŠ¤íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedFiles.length === 0) {
        alert("ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      submitBtn.disabled = true; 
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì—…ë¡œë“œ ì¤‘...';

      try{
        const uploadedUrls = [];
        
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const webpBlob = await convertToWebP(file);
          
          const uploadResult = await firebaseDataManager.uploadImage(webpBlob, 'img/posting');
          if (!uploadResult.success) {
            throw new Error(uploadResult.error);
          }
          uploadedUrls.push(uploadResult.url);
        }

        const tagText = tagsEl.value.trim();
        const tags = tagText ? tagText.split(/\s+/).map(tag => 
          tag.startsWith('#') ? tag : `#${tag}`
        ).filter(Boolean) : [];

        // DBì—ì„œ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        let authorName = currentUser.displayName || currentUser.email.split('@')[0];
        try {
          const memberRef = firebaseDataManager.getDocRef('members', currentUser.uid);
          const memberSnap = await firebaseDataManager.getDocument(memberRef);
          if (memberSnap.exists()) {
            const memberData = memberSnap.data();
            authorName = memberData.name || authorName;
          }
        } catch (error) {
          // DBì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
        }

        const photoData = {
          urls: uploadedUrls,
          caption: captionEl.value.trim(),
          location: locationEl.value.trim(),
          author: authorName,
          tags: tags,
          uploadedBy: currentUser.uid,
          isMultiImage: uploadedUrls.length > 1
        };
        
        await firebaseDataManager.addPhoto(photoData);
        dlg.close(); 
        await render(q.value);
        alert('í¬ìŠ¤íŒ…ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      }catch(err){
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
      }finally{
        submitBtn.disabled=false; 
        submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> ê³µìœ í•˜ê¸°';
      }
    });

    const headerComponent = new HeaderComponent();
    
    // í—¤ë” ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” í™•ì¸
    setTimeout(() => {
      if (headerComponent && typeof headerComponent.updateLoginButton === 'function') {
        headerComponent.updateLoginButton();
      }
    }, 1000);
    
    const loginModal = document.getElementById('loginModal');
    const loginModalClose = document.getElementById('loginModalClose');
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    function openLoginModal() {
      loginModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeLoginModal() {
      loginModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    googleLoginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const result = await firebaseDataManager.signInWithGoogle();
        if (result.success) {
          currentUser = result.user;
          await checkUserPermissions();
          updateUploadButtonVisibility();
          closeLoginModal();
          
          if (isAdmin) {
            alert(`âœ… ê´€ë¦¬ì ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          } else if (isApprovedUser) {
            alert(`âœ… ìŠ¹ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤. ì‚¬ì§„ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          } else {
            alert(`â³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.\n\nì „ì‚¬ë„ë¡œë¡±ì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.`);
          }
          
          // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
      } catch (error) {
        // console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    loginModalClose.addEventListener('click', closeLoginModal);
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') {
        closeLoginModal();
      }
    });

    async function checkUserPermissions() {
      if (!currentUser) {
        isAdmin = false;
        isApprovedUser = false;
        userLikedPosts.clear();
        return;
      }
      
      try {
        const memberRef = firebaseDataManager.getDocRef('members', currentUser.uid);
        const memberSnap = await firebaseDataManager.getDocument(memberRef);
        
        if (memberSnap.exists()) {
          const memberData = memberSnap.data();
          isApprovedUser = memberData.status === 'approved';
        } else {
          isApprovedUser = false;
        }
        
        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        isAdmin = await firebaseDataManager.isAdmin(currentUser.uid);
        
        // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”í•œ í¬ìŠ¤íŠ¸ ë¡œë“œ
        userLikedPosts = await loadUserLikedPosts(currentUser.uid);
        
      } catch (error) {
        // console.error('ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ì˜¤ë¥˜:', error);
        isAdmin = false;
        isApprovedUser = false;
        userLikedPosts.clear();
      }
    }

    function checkAuthState() {
      if (typeof firebaseDataManager === 'undefined') {
        return;
      }
      
      const currentUserCheck = firebaseDataManager.getCurrentUser();
      if (currentUserCheck) {
        currentUser = currentUserCheck;
        checkUserPermissions().then(() => {
          updateUploadButtonVisibility();
        });
      } else {
        currentUser = null;
        isAdmin = false;
        isApprovedUser = false;
        updateUploadButtonVisibility();
      }
      
      firebaseDataManager.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await checkUserPermissions();
          updateUploadButtonVisibility();
        } else {
          currentUser = null;
          isAdmin = false;
          isApprovedUser = false;
          updateUploadButtonVisibility();
        }
      });
    }

    async function initializePage() {
      try {
        if (typeof firebaseDataManager === 'undefined') {
          setTimeout(initializePage, 1000);
          return;
        }
        
        await Promise.all([
          render(),
          loadNoticePreview()
        ]);
        checkAuthState();
        
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ id í™•ì¸í•˜ì—¬ ìƒì„¸ í˜ì´ì§€ ì—´ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const photoId = urlParams.get('id');
        if (photoId) {
          // ìƒˆë¡œ í¬ìŠ¤íŒ…ëœ ì´ë¯¸ì§€ê°€ Firestoreì— ë°˜ì˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° í›„ ìƒì„¸ í˜ì´ì§€ ì—´ê¸°
          setTimeout(() => {
            openDetailWithRetry(photoId);
          }, 1000);
        }
      } catch (error) {
        // console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë¡œê·¸ í•œë„ ì´ˆê³¼ë¡œ ì£¼ì„ì²˜ë¦¬)
      // if (typeof firebaseDataManager !== 'undefined') {
      //   try {
      //     await firebaseDataManager.initSecurity();
      //   } catch (error) {
      //     // ë³´ì•ˆ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ í˜ì´ì§€ëŠ” ì •ìƒ ì‘ë™
      //   }
      // }
      
      // ê¸€ì“°ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      const createPostBtn = document.getElementById('createPostBtn');
      if (createPostBtn) {
        createPostBtn.addEventListener('click', () => {
          window.location.href = 'create-post.html';
        });
      }
      
      setTimeout(initializePage, 500);
    });

  </script>
</body>
</html>
