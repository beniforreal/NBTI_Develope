<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë§ˆì´í˜ì´ì§€ - NBTI ê¸¸ë“œ</title>
  <meta name="color-scheme" content="dark light">
  
  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
  <link rel="manifest" href="./site.webmanifest">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nbti.kro.kr/mypage.html">
  <meta property="og:title" content="ë§ˆì´í˜ì´ì§€ - NBTI ê¸¸ë“œ">
  <meta property="og:description" content="NBTI ê¸¸ë“œì›ì˜ ê°œì¸ í”„ë¡œí•„ì„ ê´€ë¦¬í•˜ê³  ì„¤ì •ì„ ë³€ê²½í•˜ì„¸ìš”!">
  <meta property="og:image" content="https://nbti.kro.kr/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NBTI ê¸¸ë“œ">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://nbti.kro.kr/mypage.html">
  <meta property="twitter:title" content="ë§ˆì´í˜ì´ì§€ - NBTI ê¸¸ë“œ">
  <meta property="twitter:description" content="NBTI ê¸¸ë“œì›ì˜ ê°œì¸ í”„ë¡œí•„ì„ ê´€ë¦¬í•˜ê³  ì„¤ì •ì„ ë³€ê²½í•˜ì„¸ìš”!">
  <meta property="twitter:image" content="https://nbti.kro.kr/img/og-image.png">
  
  <!-- ê¸°íƒ€ ë©”íƒ€ íƒœê·¸ -->
  <meta name="description" content="NBTI ê¸¸ë“œì›ì˜ ê°œì¸ í”„ë¡œí•„ì„ ê´€ë¦¬í•˜ê³  ì„¤ì •ì„ ë³€ê²½í•˜ì„¸ìš”!">
  <meta name="keywords" content="ë§ˆë¹„ë…¸ê¸°, ëª¨ë°”ì¼, ë˜ì»¨ì„œë²„, NBTI, ê¸¸ë“œ, ë§ˆì´í˜ì´ì§€, í”„ë¡œí•„">
  <meta name="author" content="NBTI ê¸¸ë“œ">
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="./styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script type="module" src="./js/firebase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/supabase-config.js?v=1.0.0"></script>
  <script type="module" src="./js/firebase-data-manager.js?v=1.0.0"></script>
  <script src="./js/header-component.js?v=1.0.0"></script>
  <script src="./js/footer-component.js?v=1.0.0"></script>
  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script type="module">
    // Firebase í•¨ìˆ˜ë“¤ì€ firebase-data-manager.jsì—ì„œ ê´€ë¦¬ë¨
  </script>
</head>
<body>
  <!-- í—¤ë”ëŠ” í—¤ë” ì»´í¬ë„ŒíŠ¸ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <!-- <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">ë§ˆì´í˜ì´ì§€</h1> -->
    </div>
  </section>

  <div class="wrap">
    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div id="loginSection" class="login-section">
      <div class="login-card">
        <h2>ê¸¸ë“œì› ë¡œê·¸ì¸</h2>
        <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <button type="button" class="btn btn-google" id="googleLoginBtn">
          <i class="fab fa-google"></i>
          Googleë¡œ ë¡œê·¸ì¸
        </button>
      </div>
    </div>

    <!-- ë§ˆì´í˜ì´ì§€ ì„¹ì…˜ -->
    <div id="mypageSection" class="mypage-section" style="display: none;">
      <div class="page-header">
        <div class="page-title-row">
          <h1>ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h1>
        </div>
      </div>

      <div class="mypage-content">
        <!-- í”„ë¡œí•„ ì¹´ë“œ -->
        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-cover" id="profileCover">
              <div class="cover-upload-overlay">
                <input type="file" id="coverFile" accept="image/*" style="display: none;">
                <button type="button" class="cover-upload-icon" id="uploadCoverBtn" title="ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ">
                  <i class="fa-solid fa-camera"></i>
                </button>
              </div>
            </div>
            <div class="profile-info">
              <h2 id="profileName"></h2>
              <p id="profileRole"></p>
              <p id="profileEmail"></p>
              <div id="userStatus" class="user-status"></div>
            </div>
          </div>
        </div>

        <!-- í¸ì§‘ í¼ -->
        <div class="edit-form-card">
          <h3>í”„ë¡œí•„ í¸ì§‘</h3>
          <form id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="editName">ë‹‰ë„¤ì„</label>
                <input type="text" id="editName" required>
              </div>
              <div class="form-group">
                <label for="editMbti">MBTI</label>
                <input type="text" id="editMbti" placeholder="ì˜ˆ: ENFP" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="editRole">ì§ì±…</label>
              <input type="text" id="editRole" placeholder="ì˜ˆ: ê¸¸ë“œì›, ë¶€ê¸¸ë“œì¥" required>
            </div>
            
            <div class="form-group">
              <label for="editBio">í•œ ì¤„ ì†Œê°œ</label>
              <input type="text" id="editBio" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
              <label for="editTags">íƒœê·¸</label>
              <div class="tag-input-container">
                <input type="text" id="editTags" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (ì˜ˆ: #ê¸¸ë“œì› #ë ˆì´ë“œ)">
                <div class="tag-list" id="tagList"></div>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- í¬ë¡­ ëª¨ë‹¬ -->
  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
      <div class="crop-modal-header">
        <h3>í”„ë¡œí•„ ì´ë¯¸ì§€ í¸ì§‘</h3>
        <button class="crop-modal-close" id="cropModalClose">&times;</button>
      </div>
      <div class="crop-modal-body">
        <div class="crop-container">
          <img id="cropImage" src="" alt="í¬ë¡­í•  ì´ë¯¸ì§€">
        </div>
        <div class="crop-controls">
          <button type="button" class="btn btn-secondary" id="cropCancel">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="cropConfirm">ì ìš©</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const headerComponent = new HeaderComponent();
    
    // í—¤ë” ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” í™•ì¸
    setTimeout(() => {
      if (headerComponent && typeof headerComponent.updateLoginButton === 'function') {
        headerComponent.updateLoginButton();
      }
    }, 1000);
    
    const loginSection = document.getElementById('loginSection');
    const mypageSection = document.getElementById('mypageSection');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const profileForm = document.getElementById('profileForm');
    const uploadCoverBtn = document.getElementById('uploadCoverBtn');
    const coverFile = document.getElementById('coverFile');
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const cropModalClose = document.getElementById('cropModalClose');
    const cropCancel = document.getElementById('cropCancel');
    const cropConfirm = document.getElementById('cropConfirm');
    
    const profileName = document.getElementById('profileName');
    const profileRole = document.getElementById('profileRole');
    const profileEmail = document.getElementById('profileEmail');
    const profileCover = document.getElementById('profileCover');
    
    const editName = document.getElementById('editName');
    const editMbti = document.getElementById('editMbti');
    const editRole = document.getElementById('editRole');
    const editBio = document.getElementById('editBio');
    const editTags = document.getElementById('editTags');
    const tagList = document.getElementById('tagList');
    
    let currentUser = null;
    let userProfile = null;
    let selectedTags = [];
    let cropper = null;
    let currentFile = null;

    function openCropModal(file) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        cropImage.src = e.target.result;
        cropModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Cropper ì´ˆê¸°í™”
        setTimeout(() => {
          if (cropper) {
            cropper.destroy();
          }
          cropper = new Cropper(cropImage, {
            aspectRatio: 1, // ì •ì‚¬ê°í˜• ë¹„ìœ¨
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            background: false,
            modal: true,
            responsive: true,
            checkCrossOrigin: false
          });
        }, 100);
      };
      reader.readAsDataURL(file);
    }

    function closeCropModal() {
      cropModal.style.display = 'none';
      document.body.style.overflow = '';
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentFile = null;
      coverFile.value = '';
    }

    function convertCroppedImageToWebP(quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!cropper) {
          reject(new Error('í¬ë¡­ ë„êµ¬ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
          return;
        }
        
        try {
          const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400,
            minWidth: 200,
            minHeight: 200,
            maxWidth: 800,
            maxHeight: 800,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
          });
          
          if (!canvas) {
            reject(new Error('í¬ë¡­ëœ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
            return;
          }
          
          canvas.toBlob((blob) => {
            if (blob && blob.size > 0) {
              resolve(blob);
            } else {
              reject(new Error('WebP ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ë¹ˆ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'));
            }
          }, 'image/webp', quality);
        } catch (error) {
          reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ' + error.message));
        }
      });
    }

    function convertToWebP(file, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
          reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤'));
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
          reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (10MB ì œí•œ)'));
          return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          try {
            if (img.width === 0 || img.height === 0) {
              reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ í¬ê¸°'));
              return;
            }
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob((blob) => {
              if (blob && blob.size > 0) {
                resolve(blob);
              } else {
                reject(new Error('WebP ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ë¹ˆ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'));
              }
            }, 'image/webp', quality);
          } catch (error) {
            reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ' + error.message));
          }
        };
        
        img.onerror = (error) => {
          reject(new Error('WebP ë³€í™˜ ì‹¤íŒ¨: ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
        };
        
        img.src = URL.createObjectURL(file);
      });
    }

    function addTag(tagText) {
      const tag = tagText.trim();
      if (!tag || selectedTags.includes(tag)) return;
      
      const formattedTag = tag.startsWith('#') ? tag : `#${tag}`;
      selectedTags.push(formattedTag);
      displayTags();
    }

    function displayTags() {
      tagList.innerHTML = '';
      selectedTags.forEach((tag, index) => {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-item';
        tagElement.innerHTML = `
          ${tag}
          <button type="button" class="remove-tag" data-index="${index}">
            <i class="fa-solid fa-times" style="color: black;"></i>
          </button>
        `;
        
        tagElement.querySelector('.remove-tag').addEventListener('click', () => {
          selectedTags.splice(index, 1);
          displayTags();
        });
        
        tagList.appendChild(tagElement);
      });
    }

    googleLoginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const result = await firebaseDataManager.signInWithGoogle();
        if (result.success) {
          currentUser = result.user;
          
          await checkAndLoadUserProfile();
          
          showMypage();
          
          if (userProfile && userProfile.status === 'approved') {
            alert(`âœ… ìŠ¹ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤. ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          } else {
            alert(`â³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.\n\nì „ì‚¬ë„ë¡œë¡±ì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.`);
          }
          
          // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
      } catch (error) {
        // console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    async function checkAndLoadUserProfile() {
      if (!currentUser) return;
      
      if (typeof firebaseDataManager === 'undefined') {
        return;
      }
      
      try {
        const memberRef = firebaseDataManager.getDocRef('members', currentUser.uid);
        const memberSnap = await firebaseDataManager.getDocument(memberRef);
        
        if (memberSnap.exists()) {
          userProfile = { id: memberSnap.id, ...memberSnap.data() };
        } else {
          userProfile = {
            id: currentUser.uid,
            name: currentUser.displayName || currentUser.email.split('@')[0],
            email: currentUser.email,
            mbti: '',
            role: 'ê¸¸ë“œì›',
            bio: 'Google ë¡œê·¸ì¸ìœ¼ë¡œ ê°€ì…í•œ ìƒˆ ë©¤ë²„ì…ë‹ˆë‹¤.',
            tags: ['#ìƒˆë©¤ë²„'],
            cover: null,
            createdAt: new Date(),
            updatedAt: new Date()
          };
          
          const result = await firebaseDataManager.saveUserProfile(currentUser.uid, userProfile);
        }
      } catch (error) {
        // console.error('í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser || !userProfile) return;
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const updateData = {
          name: editName.value,
          mbti: editMbti.value,
          role: editRole.value,
          bio: editBio.value,
          tags: selectedTags
        };
        
        const result = await firebaseDataManager.saveUserProfile(currentUser.uid, updateData);
        
        if (result.success) {
          userProfile = { ...userProfile, ...updateData };
          
          updateProfileDisplay();
          
          if (result.status === 'approved') {
            alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ… ìŠ¹ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.');
          } else {
            alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ³ ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...\n\nìŠ¹ì¸ í›„ ê¸¸ë“œì› ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.');
          }
        } else {
          alert('í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
      } catch (error) {
        // console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });


    uploadCoverBtn.addEventListener('click', () => {
      coverFile.click();
    });

    coverFile.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || !currentUser) return;
      
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // íŒŒì¼ í¬ê¸° ì²´í¬
      if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        coverFile.value = '';
        return;
      }
      
      // ì´ë¯¸ì§€ íŒŒì¼ ì²´í¬
      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        coverFile.value = '';
        return;
      }
      
      // í¬ë¡­ ëª¨ë‹¬ ì—´ê¸°
      openCropModal(file);
    });

    function showLogin() {
      loginSection.style.display = 'block';
      mypageSection.style.display = 'none';
    }

    function showMypage() {
      loginSection.style.display = 'none';
      mypageSection.style.display = 'block';
      loadProfileToForm();
      updateProfileDisplay();
    }

    function loadProfileToForm() {
      if (!userProfile) return;
      
      editName.value = userProfile.name || '';
      editMbti.value = userProfile.mbti || '';
      editRole.value = userProfile.role || '';
      editBio.value = userProfile.bio || '';
      
      selectedTags = userProfile.tags || [];
      displayTags();
    }

    function updateProfileDisplay() {
      if (!userProfile) return;
      
      profileName.textContent = userProfile.name || '';
      profileRole.textContent = `${userProfile.mbti || ''} | ${userProfile.role || ''}`;
      profileEmail.textContent = userProfile.email || '';
      
      const userStatus = document.getElementById('userStatus');
      if (userStatus) {
        const status = userProfile.status || 'pending';
        let statusText = '';
        let statusClass = '';
        
        switch (status) {
          case 'approved':
            statusText = 'âœ… ìŠ¹ì¸ë¨';
            statusClass = 'status-approved';
            break;
          case 'pending':
            statusText = 'â³ ê´€ë¦¬ì í™•ì¸ ì¤‘...';
            statusClass = 'status-pending';
            break;
          case 'rejected':
            statusText = 'âŒ ìŠ¹ì¸ ê±°ë¶€ë¨';
            statusClass = 'status-rejected';
            break;
          default:
            statusText = 'â³ ê´€ë¦¬ì í™•ì¸ ì¤‘...';
            statusClass = 'status-pending';
        }
        
        userStatus.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
      }
      
      const coverStyle = userProfile.cover ? 
        `background-image: url('${userProfile.cover}')` : 
        `background-image: url('img/cover.webp')`;
      profileCover.style.cssText = coverStyle;
    }

    async function initializePage() {
      if (typeof firebaseDataManager === 'undefined') {
        alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const currentUserCheck = firebaseDataManager.getCurrentUser();
      if (currentUserCheck) {
        currentUser = currentUserCheck;
        await checkAndLoadUserProfile();
        showMypage();
      } else {
        currentUser = null;
        userProfile = null;
        showLogin();
      }
      
      firebaseDataManager.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await checkAndLoadUserProfile();
          showMypage();
        } else {
          currentUser = null;
          userProfile = null;
          showLogin();
        }
      });
    }

    editTags.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag(editTags.value);
        editTags.value = '';
      }
    });

    // í¬ë¡­ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    cropModalClose.addEventListener('click', closeCropModal);
    cropCancel.addEventListener('click', closeCropModal);
    
    cropConfirm.addEventListener('click', async () => {
      if (!cropper || !currentUser) return;
      
      uploadCoverBtn.disabled = true;
      cropConfirm.disabled = true;
      cropConfirm.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
      
      try {
        // ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
        if (userProfile && userProfile.cover) {
          await firebaseDataManager.deleteImage(userProfile.cover);
        }
        
        // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ WebPë¡œ ë³€í™˜
        const webpBlob = await convertCroppedImageToWebP();
        
        // Supabase Storageì— ì—…ë¡œë“œ
        const uploadResult = await firebaseDataManager.uploadImage(webpBlob, 'img/profile');
        if (!uploadResult.success) {
          throw new Error(uploadResult.error);
        }
        const downloadURL = uploadResult.url;
        
        // í”„ë¡œí•„ì— ì €ì¥
        const result = await firebaseDataManager.saveUserProfile(currentUser.uid, { 
          cover: downloadURL
        });
        
        if (!result.success) {
          throw new Error(result.error);
        }
        
        userProfile.cover = downloadURL;
        updateProfileDisplay();
        
        closeCropModal();
        
        if (result.status === 'approved') {
          alert('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ… í¬ë¡­ ë° WebP ìµœì í™” ì™„ë£Œ\n\nğŸ—‘ï¸ ê¸°ì¡´ ì´ë¯¸ì§€ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤\n\nìŠ¹ì¸ëœ ì‚¬ìš©ìì´ë¯€ë¡œ ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.');
        } else {
          alert('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ… í¬ë¡­ ë° WebP ìµœì í™” ì™„ë£Œ\n\nğŸ—‘ï¸ ê¸°ì¡´ ì´ë¯¸ì§€ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤\n\nâ³ ê´€ë¦¬ì í™•ì¸ í›„ ê¸¸ë“œì› ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.');
        }
        
      } catch (error) {
        // console.error('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nâŒ ' + error.message);
      } finally {
        uploadCoverBtn.disabled = false;
        cropConfirm.disabled = false;
        cropConfirm.innerHTML = 'ì ìš©';
      }
    });
    
    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    cropModal.addEventListener('click', (e) => {
      if (e.target === cropModal) {
        closeCropModal();
      }
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cropModal.style.display === 'flex') {
        closeCropModal();
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë¡œê·¸ í•œë„ ì´ˆê³¼ë¡œ ì£¼ì„ì²˜ë¦¬)
      // if (typeof firebaseDataManager !== 'undefined') {
      //   try {
      //     await firebaseDataManager.initSecurity();
      //   } catch (error) {
      //     // ë³´ì•ˆ ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ í˜ì´ì§€ëŠ” ì •ìƒ ì‘ë™
      //   }
      // }
      
      initializePage();
    });
  </script>
</body>
</html>
